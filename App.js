// ===============================================
//    VERSION ULTIME AVEC D√âBOGAGE INT√âGR√â
// ===============================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log("üîÑ D√©marrage de l'application...");

        // 1. Configuration de Supabase - V√âRIFIEZ CES URL ET CL√âS!
            const supabaseUrl = "https://xfpkiowdevrrhsaundrz.supabase.co";
                const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhmcGtpb3dkZXZycmhzYXVuZHJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3Mjk2MDYsImV4cCI6MjA3MjMwNTYwNn0.Lqqyo1asUKQl5AK9AElS1xwlAjLVG9uP20z2lr_wzn8";

                    // V√©rification que Supabase est charg√©
                        if (typeof supabase === 'undefined') {
                                console.error('‚ùå ERREUR: La biblioth√®que Supabase nest pas charg√©e!');
                                        showError('V√©rifiez votre connexion internet et rechargez la page.');
                                                return;
                                                    }

                                                        const sb = supabase.createClient(supabaseUrl, supabaseAnonKey);
                                                            console.log("‚úÖ Client Supabase initialis√©");

                                                                // R√©f√©rences aux √©l√©ments du DOM
                                                                    const qcmLoader = document.getElementById('qcm-loader');
                                                                        const qcmContent = document.getElementById('qcm-content');
                                                                            const qcmQuestion = document.getElementById('qcm-question');
                                                                                const checkAnswerBtn = document.getElementById('check-answer-btn');
                                                                                    const nextQcmBtn = document.getElementById('next-qcm-btn');

                                                                                        // Test de connexion IMM√âDIAT √† Supabase
                                                                                            try {
                                                                                                    console.log("üß™ Test de connexion √† Supabase...");
                                                                                                            const { data, error } = await sb.from('qcm').select('count').limit(1);
                                                                                                                    
                                                                                                                            if (error) {
                                                                                                                                        console.error('‚ùå Erreur de connexion Supabase:', error);
                                                                                                                                                    showError('Impossible de se connecter √† la base de donn√©es. V√©rifiez la console (F12) pour plus de d√©tails.');
                                                                                                                                                                return;
                                                                                                                                                                        }
                                                                                                                                                                                
                                                                                                                                                                                        console.log("‚úÖ Connexion Supabase r√©ussie!");
                                                                                                                                                                                            } catch (err) {
                                                                                                                                                                                                    console.error('‚ùå Exception lors de la connexion:', err);
                                                                                                                                                                                                            showError('Erreur de r√©seau ou CORS. V√©rifiez les param√®tres Supabase.');
                                                                                                                                                                                                                    return;
                                                                                                                                                                                                                        }

                                                                                                                                                                                                                            // Fonction pour r√©cup√©rer un QCM (version ultra-simplifi√©e)
                                                                                                                                                                                                                                async function fetchRandomQCM() {
                                                                                                                                                                                                                                        console.log("üîÑ Tentative de r√©cup√©ration d'un QCM...");
                                                                                                                                                                                                                                                qcmLoader.classList.remove('hidden');
                                                                                                                                                                                                                                                        qcmContent.classList.add('hidden');

                                                                                                                                                                                                                                                                try {
                                                                                                                                                                                                                                                                            // ESSAYEZ D'ABORD une requ√™te SIMPLE sans RPC
                                                                                                                                                                                                                                                                                        const { data, error } = await sb
                                                                                                                                                                                                                                                                                                        .from('qcm')
                                                                                                                                                                                                                                                                                                                        .select('*')
                                                                                                                                                                                                                                                                                                                                        .limit(1);

                                                                                                                                                                                                                                                                                                                                                    if (error) {
                                                                                                                                                                                                                                                                                                                                                                    console.error('Erreur Supabase:', error);
                                                                                                                                                                                                                                                                                                                                                                                    throw error;
                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                            if (!data || data.length === 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                            throw new Error('Aucune question trouv√©e dans la base de donn√©es');
                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.log('‚úÖ QCM r√©cup√©r√©:', data[0]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                displayQCM(data[0]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.error('‚ùå Erreur fetchRandomQCM:', err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            qcmQuestion.textContent = "Erreur: " + err.message;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        qcmLoader.classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    qcmContent.classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    function displayQCM(qcm) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Votre logique d'affichage existante
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('qcm-module').textContent = qcm.module || '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('qcm-question').textContent = qcm.question || '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Logique pour les options...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const optionsContainer = document.getElementById('qcm-options');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            optionsContainer.innerHTML = '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // VOTRE LOGIQUE D'AFFICHAGE DES OPTIONS ICI
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            qcmLoader.classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    qcmContent.classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function showError(message) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const errorDiv = document.createElement('div');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            errorDiv.style.color = 'red';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    errorDiv.style.padding = '1rem';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            errorDiv.style.margin = '1rem';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    errorDiv.style.border = '1px solid red';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            errorDiv.textContent = message;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.body.prepend(errorDiv);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // D√©marrage
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                fetchRandomQCM();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });